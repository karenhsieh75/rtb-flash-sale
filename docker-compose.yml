version: '3.8'

services:
  # 1. Redis: 用來做即時排行榜、扣庫存 (快取層)
  redis:
    image: redis:alpine
    container_name: auction_redis
    ports:
      - "6379:6379"  # 開放 port 讓你的程式連線
    command: redis-server --appendonly yes # 讓資料持久化一點，避免重開全不見
    volumes:
      - ./redis_data:/data

  # 2. PostgreSQL: 用來存最終訂單、會員資料 (資料庫層)
  db:
    image: postgres:13-alpine
    container_name: auction_db
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: admin       # 帳號
      POSTGRES_PASSWORD: password123 # 密碼 (測試用簡單就好)
      POSTGRES_DB: auction_db    # 資料庫名稱
    volumes:
      - postgres_data:/var/lib/postgresql/data # 確保重開機資料還在
  
  # 3. Backend
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile.dev  # 開發環境
    container_name: auction_backend
    ports:
      - "8000:8000"
    environment:
      - REDIS_HOST=auction_redis 
      - DB_HOST=auction_db
    depends_on:
      - redis
      - db
    volumes:
      - ./backend:/app

  # 4. Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev  # 開發環境
    container_name: auction_frontend
    ports:
      - "5173:5173"
    environment:
      # React 是在瀏覽器執行，不是在 Docker 容器裡執行，所以是用 localhost
      - VITE_API_BASE_URL=http://localhost:8000 
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
      - /app/node_modules # 避免覆蓋容器內的 node_modules 

# 定義 Volumes
volumes:
  postgres_data: