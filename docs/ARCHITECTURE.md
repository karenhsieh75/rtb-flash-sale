# 系统架构文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         Client Layer                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   Browser    │  │   Browser    │  │   Browser    │          │
│  │  (React App) │  │  (React App) │  │  (React App) │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
│         │                  │                  │                  │
│         └──────────────────┼──────────────────┘                 │
│                            │                                     │
│                    HTTP/WebSocket                               │
└────────────────────────────┼─────────────────────────────────────┘
                              │
┌─────────────────────────────┼─────────────────────────────────────┐
│                    API Gateway Layer                              │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Gin HTTP Server (Port 8000)                 │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │   │
│  │  │   Auth       │  │   Product    │  │   Bidding    │   │   │
│  │  │  Handler     │  │   Handler    │  │   Handler    │   │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐  │   │
│  │  │         WebSocket Hub (Port 8000/ws)              │  │   │
│  │  │  - 管理所有 WebSocket 连接                        │  │   │
│  │  │  - 广播排行榜和商品更新                           │  │   │
│  │  └──────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────┼─────────────────────────────────────┘
                              │
┌─────────────────────────────┼─────────────────────────────────────┐
│                      Service Layer                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │   Auth       │  │   Product    │  │   Bidding    │            │
│  │  Service     │  │   Service    │  │   Service    │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│         │                 │                 │                     │
└─────────┼─────────────────┼─────────────────┼─────────────────────┘
          │                 │                 │
          │                 │                 │
┌─────────┼─────────────────┼─────────────────┼─────────────────────┐
│         │                 │                 │    Data Layer        │
│         │                 │                 │                      │
│  ┌──────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐              │
│  │ PostgreSQL  │  │    Redis    │  │    Redis    │              │
│  │             │  │   (Config)  │  │  (Ranking)  │              │
│  │ - Users     │  │             │  │             │              │
│  │ - Products  │  │ - Product   │  │ - Sorted    │              │
│  │ - BidLogs  │  │   Config    │  │   Set       │              │
│  │             │  │             │  │   (Top K)  │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              Lua Script (Atomic Operations)               │  │
│  │  - 防止超卖                                               │  │
│  │  - 原子性更新排行榜                                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────┘
```

## 数据流

### 出价流程

```
1. 用户提交出价
   ↓
2. Bidding Handler 接收请求
   ↓
3. Bidding Service 处理：
   - 从 Redis 读取商品配置
   - 计算 Score
   - 执行 Lua Script（原子操作）：
     * 检查活动时间
     * 更新排行榜（Sorted Set）
     * 更新最高价
   ↓
4. 异步写入数据库（BidLog）
   ↓
5. WebSocket 广播：
   - 出价通知
   - 排行榜更新
   ↓
6. 前端实时更新 UI
```

### 排行榜查询流程

```
1. 用户请求排行榜
   ↓
2. Bidding Handler 接收请求
   ↓
3. Bidding Service：
   - 从 Redis 读取排行榜（Sorted Set）
   - 从 Redis 读取商品配置（K, 最高价）
   - 计算阈值分数
   ↓
4. 返回排行榜数据
```

## 技术栈

### 后端
- **语言**: Go 1.25
- **框架**: Gin
- **数据库**: PostgreSQL 13
- **缓存**: Redis (Alpine)
- **WebSocket**: gorilla/websocket
- **认证**: JWT

### 前端
- **框架**: React 19.2
- **语言**: TypeScript
- **构建**: Vite 7.2
- **样式**: Tailwind CSS 3.4
- **路由**: React Router DOM 7.1

### 基础设施
- **容器化**: Docker + Docker Compose
- **编排**: Docker Compose

## 关键设计决策

### 1. Redis 作为排行榜存储
- **原因**: 需要高性能的排序和实时更新
- **数据结构**: Sorted Set (ZSET)
- **优势**: O(log N) 插入和查询，自动排序

### 2. Lua Script 防止超卖
- **原因**: 确保原子性操作，避免竞态条件
- **实现**: Redis EvalSha 执行 Lua 脚本
- **优势**: 单线程执行，保证一致性

### 3. WebSocket 实时推送
- **原因**: 减少轮询请求，提供实时体验
- **实现**: gorilla/websocket Hub 模式
- **优势**: 低延迟，双向通信

### 4. 异步数据库写入
- **原因**: 提高响应速度，不影响用户体验
- **实现**: Goroutine 异步写入
- **优势**: 快速响应，最终一致性

## 扩展性设计

### 水平扩展
- **无状态 API**: 可以部署多个后端实例
- **Redis 集群**: 支持 Redis Cluster
- **数据库读写分离**: 可以配置主从复制

### 垂直扩展
- **资源监控**: CPU、内存使用率
- **连接池**: 数据库和 Redis 连接池
- **缓存策略**: Redis 缓存热点数据

## 一致性保证

### 强一致性
- **排行榜更新**: Lua Script 原子操作
- **库存检查**: Lua Script 中检查活动时间

### 最终一致性
- **数据库写入**: 异步写入，最终一致
- **WebSocket 推送**: 可能延迟，但最终会同步

## 性能优化

### 后端优化
1. **Redis 缓存**: 排行榜和商品配置
2. **连接池**: 数据库和 Redis 连接复用
3. **异步处理**: 数据库写入异步化
4. **Lua Script**: 减少网络往返

### 前端优化
1. **WebSocket**: 减少 HTTP 轮询
2. **组件懒加载**: React 代码分割
3. **缓存策略**: 本地缓存商品列表

## 监控与日志

### 关键指标
- **响应时间**: p50, p95, p99
- **错误率**: 4xx, 5xx 错误比例
- **吞吐量**: RPS (Requests Per Second)
- **并发连接**: WebSocket 连接数

### 日志
- **访问日志**: Gin 默认日志
- **错误日志**: 结构化错误记录
- **性能日志**: 关键操作耗时

## 安全考虑

### 认证与授权
- **JWT Token**: 无状态认证
- **角色控制**: Admin/Member 权限分离
- **Token 过期**: 24 小时有效期

### 数据安全
- **密码加密**: bcrypt 哈希
- **SQL 注入防护**: GORM 参数化查询
- **XSS 防护**: React 自动转义

## 部署架构

### 开发环境
```
Docker Compose
├── Redis (单节点)
├── PostgreSQL (单节点)
├── Backend (开发模式)
└── Frontend (开发模式)
```

### 生产环境（建议）
```
Load Balancer
├── Backend Instance 1
├── Backend Instance 2
├── Backend Instance N
│
Redis Cluster
├── Redis Node 1
├── Redis Node 2
└── Redis Node 3
│
PostgreSQL (主从复制)
├── Primary
└── Replica
```

